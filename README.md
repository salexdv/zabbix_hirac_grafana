# Zabbix + Grafana для мониторинга кластеров 1С через [HiRAC](https://github.com/arkuznetsov/hirac)

![Мониторинг](https://github.com/salexdv/git_images/blob/master/zbx_grf_hirac_grafana.png?raw=true)

## Описание

Набор контейнеров для запуска в Docker для организации мониторинга. В контейнерах запускается только Zabbix и Grafana. Выбор версии 5.2 для Zabbix обусловлен тем, что это последняя версия, в которой есть группы элементов данных. В более поздних версиях их заменили теги, которые кажутся менее удобными.

![Группировка элементов](https://github.com/salexdv/git_images/blob/master/zbx_grf_hirac_zabbix.png?raw=true)

## Запуск

### Zabbix+Grafana

```bash
docker-compose up -d
```

* После успешного запуска веб-интерфейс Zabbix будет доступна по адресу [http://localhost:8080](http://localhost:8080)
* Веб-интерфейс Grafana будет доступен по адресу [http://localhost:3000](http://localhost:3000)

### HiRAC

Процесс установки и запуска HiRAC описан в его [документации](https://github.com/arkuznetsov/hirac)

## Использование, настройки

### Zabbix

* В zabbix следует загрузить шаблон [`1C Cluster`](templates/zabbix/zbx_export_templates.json)
* Создать новый узел с именем `1c host`, присвоить ему группу `1C Servers` и добавить к нему шаблон `1C Cluster`.
* Задать в качестве значения для унаследованного макроса `{$HIRAC_ADDRESS}` адрес HiRAC

Имя узла, конечно, может быть произвольным. Здесь оно задано явно, чтобы не было проблем с шаблоном grafana т.к. значение `1c host` используется там для фильтрации данных. Этот момент можно переделать, если необходимо мониторить несколько кластеров 1С. В последних версиях zabbix шаблон тоже работает, но вместо групп элементов данных будут теги с такими же наименованиями. Логин и пароль по умолчанию для веб-интерфейса `Admin/zabbix`

### Grafana

* Добавить новый источник данных `MySQL` со значением хоста `mysql-server`. Имя базы данных, а также логин/пароль из файла [.env_db_mysql](env_vars/.env_db_mysql)
* Активировать уже установленный плагин `Zabbix`
* Добавить новый источник данных `Zabbix` со значением URL `http://zabbix-web-nginx-mysql:8080/api_jsonrpc.php`. Логин и пароль такие же, как в веб-интерфейсе zabbix
* Включить `Direct DB Connection` и выбрать в качестве источника ранее созданный MySQL
* Импортировать шаблон панели из файла [`cluster_dashboard`](templates/grafana/cluster_dashboard.json)

Логин и пароль по умолчанию для веб-интерфейса `admin/admin`

## Мониторинг

Вышеупомянутые шаблоны предоставляют возможность собирать базовую информацию о работе кластера, а также позволяют получить простую визуализацию данной информации. В представленных шаблонах нет триггеров для проблемных ситуаций, нет правил обнаружения высокой нагрузки и нет оповещений. Всё это настраивается индивидуально.

### Отслеживаемые показатели

#### В разрезе кластера

* **server count** - количество рабочих серверов
* **process count** - количество рабочих процессов
* **process memory** - суммарное потребление оперативной памяти рабочими процессами
* **infobase count** - количество информационных баз
* **session count** - количество сеансов

#### В разрезе рабочих процессов

* **available-perfomance** - доступная производительность процесса
* **avg-call-time** - время обслуживания процессом одного клиентского обращения
* **capacity** - потенциал процесса
* **connections** - количество сеансов
* **is-enable** - признак использования
* **memory-excess-time** - время превышения критического объема памяти процесса
* **memory-size** - потребление оперативной памяти процессом

#### В разрезе информационных баз

Показатели суммируются по сеансам

* **blocked-by-dbms** - заблокировано СУБД
* **cpu-time-5min-last** - процессорное время за последние 5 минут
* **cpu-time-current** - текущее процессорное время
* **db-proc-took** - захвачено СУБД
* **duration-current** - текущее время вызова
* **duration-current-dbms** - текущее время вызова СУБД
* **duration-last-5min** - время вызовов за последние 5 минут
* **duration-last-5min-dbms** - время вызовов СУБД за последние 5 минут
* **memory-current** - текущее потребление оперативной памяти
* **memory-total** - общее потребление оперативной памяти
* **session count** - количество сеансов

#### В разрезе сеансов

В шаблоне нет настроенных правил обнаружения для сеансов, но есть элемент данных, который собирает следующие данные:

* **session** - уникальный идентификатор сеанса
* **session-id** - номер сеанса
* **infobase** - уникальный идентификатор информационной базы
* **infobase-label** - наименование информационной базы
* **app-id** - приложение (тонкий клиент, конфигуратор и т.д)
* **started-at** - дата начала сеанса
* **duration** - продолжительность сеанса
* **blocked-by-dbms** - заблокировано СУБД
* **cpu-time-5min-last** - процессорное время за последние 5 минут
* **cpu-time-current** - текущее процессорное время
* **db-proc-took** - захвачено СУБД
* **duration-current** - текущее время вызова
* **duration-current-dbms** - текущее время вызова СУБД
* **duration-last-5min** - время вызовов за последние 5 минут
* **duration-last-5min-dbms** - время вызовов СУБД за последние 5 минут
* **memory-current** - текущее потребление оперативной памяти
* **memory-total** - общее потребление оперативной памяти
* **session count** - количество сеансов
